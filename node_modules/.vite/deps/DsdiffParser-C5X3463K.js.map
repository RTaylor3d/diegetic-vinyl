{
  "version": 3,
  "sources": ["../../music-metadata/lib/dsdiff/DsdiffParser.js", "../../music-metadata/lib/dsdiff/DsdiffToken.js"],
  "sourcesContent": ["import * as Token from 'token-types';\r\nimport initDebug from 'debug';\r\nimport * as strtok3 from 'strtok3';\r\nimport { FourCcToken } from '../common/FourCC.js';\r\nimport { BasicParser } from '../common/BasicParser.js';\r\nimport { ID3v2Parser } from '../id3v2/ID3v2Parser.js';\r\nimport { ChunkHeader64 } from './DsdiffToken.js';\r\nimport { makeUnexpectedFileContentError } from '../ParseError.js';\r\nconst debug = initDebug('music-metadata:parser:aiff');\r\nexport class DsdiffContentParseError extends makeUnexpectedFileContentError('DSDIFF') {\r\n}\r\n/**\r\n * DSDIFF - Direct Stream Digital Interchange File Format (Phillips)\r\n *\r\n * Ref:\r\n * - http://www.sonicstudio.com/pdf/dsd/DSDIFF_1.5_Spec.pdf\r\n */\r\nexport class DsdiffParser extends BasicParser {\r\n    async parse() {\r\n        const header = await this.tokenizer.readToken(ChunkHeader64);\r\n        if (header.chunkID !== 'FRM8')\r\n            throw new DsdiffContentParseError('Unexpected chunk-ID');\r\n        const type = (await this.tokenizer.readToken(FourCcToken)).trim();\r\n        switch (type) {\r\n            case 'DSD':\r\n                this.metadata.setFormat('container', `DSDIFF/${type}`);\r\n                this.metadata.setFormat('lossless', true);\r\n                return this.readFmt8Chunks(header.chunkSize - BigInt(FourCcToken.len));\r\n            default:\r\n                throw new DsdiffContentParseError(`Unsupported DSDIFF type: ${type}`);\r\n        }\r\n    }\r\n    async readFmt8Chunks(remainingSize) {\r\n        while (remainingSize >= ChunkHeader64.len) {\r\n            const chunkHeader = await this.tokenizer.readToken(ChunkHeader64);\r\n            //  If the data is an odd number of bytes in length, a pad byte must be added at the end\r\n            debug(`Chunk id=${chunkHeader.chunkID}`);\r\n            await this.readData(chunkHeader);\r\n            remainingSize -= (BigInt(ChunkHeader64.len) + chunkHeader.chunkSize);\r\n        }\r\n    }\r\n    async readData(header) {\r\n        debug(`Reading data of chunk[ID=${header.chunkID}, size=${header.chunkSize}]`);\r\n        const p0 = this.tokenizer.position;\r\n        switch (header.chunkID.trim()) {\r\n            case 'FVER': { // 3.1 FORMAT VERSION CHUNK\r\n                const version = await this.tokenizer.readToken(Token.UINT32_LE);\r\n                debug(`DSDIFF version=${version}`);\r\n                break;\r\n            }\r\n            case 'PROP': { // 3.2 PROPERTY CHUNK\r\n                const propType = await this.tokenizer.readToken(FourCcToken);\r\n                if (propType !== 'SND ')\r\n                    throw new DsdiffContentParseError('Unexpected PROP-chunk ID');\r\n                await this.handleSoundPropertyChunks(header.chunkSize - BigInt(FourCcToken.len));\r\n                break;\r\n            }\r\n            case 'ID3': { // Unofficial ID3 tag support\r\n                const id3_data = await this.tokenizer.readToken(new Token.Uint8ArrayType(Number(header.chunkSize)));\r\n                const rst = strtok3.fromBuffer(id3_data);\r\n                await new ID3v2Parser().parse(this.metadata, rst, this.options);\r\n                break;\r\n            }\r\n            case 'DSD':\r\n                if (this.metadata.format.numberOfChannels) {\r\n                    this.metadata.setFormat('numberOfSamples', Number(header.chunkSize * BigInt(8) / BigInt(this.metadata.format.numberOfChannels)));\r\n                }\r\n                if (this.metadata.format.numberOfSamples && this.metadata.format.sampleRate) {\r\n                    this.metadata.setFormat('duration', this.metadata.format.numberOfSamples / this.metadata.format.sampleRate);\r\n                }\r\n                break;\r\n            default:\r\n                debug(`Ignore chunk[ID=${header.chunkID}, size=${header.chunkSize}]`);\r\n                break;\r\n        }\r\n        const remaining = header.chunkSize - BigInt(this.tokenizer.position - p0);\r\n        if (remaining > 0) {\r\n            debug(`After Parsing chunk, remaining ${remaining} bytes`);\r\n            await this.tokenizer.ignore(Number(remaining));\r\n        }\r\n    }\r\n    async handleSoundPropertyChunks(remainingSize) {\r\n        debug(`Parsing sound-property-chunks, remainingSize=${remainingSize}`);\r\n        while (remainingSize > 0) {\r\n            const sndPropHeader = await this.tokenizer.readToken(ChunkHeader64);\r\n            debug(`Sound-property-chunk[ID=${sndPropHeader.chunkID}, size=${sndPropHeader.chunkSize}]`);\r\n            const p0 = this.tokenizer.position;\r\n            switch (sndPropHeader.chunkID.trim()) {\r\n                case 'FS': { // 3.2.1 Sample Rate Chunk\r\n                    const sampleRate = await this.tokenizer.readToken(Token.UINT32_BE);\r\n                    this.metadata.setFormat('sampleRate', sampleRate);\r\n                    break;\r\n                }\r\n                case 'CHNL': { // 3.2.2 Channels Chunk\r\n                    const numChannels = await this.tokenizer.readToken(Token.UINT16_BE);\r\n                    this.metadata.setFormat('numberOfChannels', numChannels);\r\n                    await this.handleChannelChunks(sndPropHeader.chunkSize - BigInt(Token.UINT16_BE.len));\r\n                    break;\r\n                }\r\n                case 'CMPR': { // 3.2.3 Compression Type Chunk\r\n                    const compressionIdCode = (await this.tokenizer.readToken(FourCcToken)).trim();\r\n                    const count = await this.tokenizer.readToken(Token.UINT8);\r\n                    const compressionName = await this.tokenizer.readToken(new Token.StringType(count, 'ascii'));\r\n                    if (compressionIdCode === 'DSD') {\r\n                        this.metadata.setFormat('lossless', true);\r\n                        this.metadata.setFormat('bitsPerSample', 1);\r\n                    }\r\n                    this.metadata.setFormat('codec', `${compressionIdCode} (${compressionName})`);\r\n                    break;\r\n                }\r\n                case 'ABSS': { // 3.2.4 Absolute Start Time Chunk\r\n                    const hours = await this.tokenizer.readToken(Token.UINT16_BE);\r\n                    const minutes = await this.tokenizer.readToken(Token.UINT8);\r\n                    const seconds = await this.tokenizer.readToken(Token.UINT8);\r\n                    const samples = await this.tokenizer.readToken(Token.UINT32_BE);\r\n                    debug(`ABSS ${hours}:${minutes}:${seconds}.${samples}`);\r\n                    break;\r\n                }\r\n                case 'LSCO': { // 3.2.5 Loudspeaker Configuration Chunk\r\n                    const lsConfig = await this.tokenizer.readToken(Token.UINT16_BE);\r\n                    debug(`LSCO lsConfig=${lsConfig}`);\r\n                    break;\r\n                }\r\n                default:\r\n                    debug(`Unknown sound-property-chunk[ID=${sndPropHeader.chunkID}, size=${sndPropHeader.chunkSize}]`);\r\n                    await this.tokenizer.ignore(Number(sndPropHeader.chunkSize));\r\n            }\r\n            const remaining = sndPropHeader.chunkSize - BigInt(this.tokenizer.position - p0);\r\n            if (remaining > 0) {\r\n                debug(`After Parsing sound-property-chunk ${sndPropHeader.chunkSize}, remaining ${remaining} bytes`);\r\n                await this.tokenizer.ignore(Number(remaining));\r\n            }\r\n            remainingSize -= BigInt(ChunkHeader64.len) + sndPropHeader.chunkSize;\r\n            debug(`Parsing sound-property-chunks, remainingSize=${remainingSize}`);\r\n        }\r\n        if (this.metadata.format.lossless && this.metadata.format.sampleRate && this.metadata.format.numberOfChannels && this.metadata.format.bitsPerSample) {\r\n            const bitrate = this.metadata.format.sampleRate * this.metadata.format.numberOfChannels * this.metadata.format.bitsPerSample;\r\n            this.metadata.setFormat('bitrate', bitrate);\r\n        }\r\n    }\r\n    async handleChannelChunks(remainingSize) {\r\n        debug(`Parsing channel-chunks, remainingSize=${remainingSize}`);\r\n        const channels = [];\r\n        while (remainingSize >= FourCcToken.len) {\r\n            const channelId = await this.tokenizer.readToken(FourCcToken);\r\n            debug(`Channel[ID=${channelId}]`);\r\n            channels.push(channelId);\r\n            remainingSize -= BigInt(FourCcToken.len);\r\n        }\r\n        debug(`Channels: ${channels.join(', ')}`);\r\n        return channels;\r\n    }\r\n}\r\n//# sourceMappingURL=DsdiffParser.js.map", "import * as Token from 'token-types';\r\nimport { FourCcToken } from '../common/FourCC.js';\r\n/**\r\n * DSDIFF chunk header\r\n * The data-size encoding is deviating from EA-IFF 85\r\n * Ref: http://www.sonicstudio.com/pdf/dsd/DSDIFF_1.5_Spec.pdf\r\n */\r\nexport const ChunkHeader64 = {\r\n    len: 12,\r\n    get: (buf, off) => {\r\n        return {\r\n            // Group-ID\r\n            chunkID: FourCcToken.get(buf, off),\r\n            // Size\r\n            chunkSize: Token.INT64_BE.get(buf, off + 4)\r\n        };\r\n    }\r\n};\r\n//# sourceMappingURL=DsdiffToken.js.map"],
  "mappings": "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",
  "names": ["initDebug"]
}
